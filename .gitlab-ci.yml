# GitLab CI/CD Pipeline - Full Stack Application
# Author: DevOps Team
# Version: 4.1.0
# Description: Optimized CI/CD pipeline for Kubernetes deployment with Flux - Multi-environment with GitOps

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*/
    - if: $CI_COMMIT_BRANCH =~ /^bugfix\/.*/

variables:
  # Maven Configuration
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Xmx2048m -XX:MaxMetaspaceSize=512m"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"

  # Application Configuration
  BACKEND_APP_NAME: "account-service-backend"
  FRONTEND_APP_NAME: "account-service-frontend"

  # Node.js Configuration
  NODE_VERSION: "20"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

  # SonarQube Configuration (Backend only)
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"

  # Container Registry Configuration
  REGISTRY: "$CI_REGISTRY"
  BACKEND_IMAGE: "$CI_REGISTRY_IMAGE/backend"
  FRONTEND_IMAGE: "$CI_REGISTRY_IMAGE/frontend"

  # GitOps Configuration - UPDATE THESE WITH YOUR ACTUAL REPOS
  GITOPS_STAGING_REPO: "${GITOPS_STAGING_REPO_URL}"  # Set as CI/CD variable
  GITOPS_PROD_REPO: "${GITOPS_PROD_REPO_URL}"        # Set as CI/CD variable

  # Lab Environment URLs - UPDATE THESE FOR YOUR LAB
  STAGING_BASE_URL: "${STAGING_URL}"     # Set as CI/CD variable (e.g., http://192.168.1.100:30080)
  PRODUCTION_BASE_URL: "${PRODUCTION_URL}" # Set as CI/CD variable (e.g., http://192.168.1.100:30081)

# Global cache configurations
.maven_cache: &maven_cache
  cache:
    key: "$CI_COMMIT_REF_SLUG-maven"
    paths:
      - .m2/repository/
    policy: pull-push

.node_cache: &node_cache
  cache:
    key: "$CI_COMMIT_REF_SLUG-node"
    paths:
      - frontend/bank-account-app/node_modules/
      - .npm/
    policy: pull-push

# Change detection rules
.backend_changes: &backend_changes
  changes:
    - backend/**/*
    - Dockerfile

.frontend_changes: &frontend_changes
  changes:
    - frontend/**/*
    - Dockerfile.frontend

# Event-based rules
.feature_branch_rules: &feature_branch_rules
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*/
    - if: $CI_COMMIT_BRANCH =~ /^bugfix\/.*/

.merge_request_rules: &merge_request_rules
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

.main_branch_rules: &main_branch_rules
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Base job templates
.java_template: &java_base
  image: eclipse-temurin:21-jdk-alpine
  before_script:
    - apk add --no-cache maven git curl
    - java --version
    - mvn --version

.node_template: &node_base
  image: node:${NODE_VERSION}-alpine
  before_script:
    - node --version
    - npm --version
    - cd frontend/bank-account-app

.kaniko_template: &kaniko_base
  image: gcr.io/kaniko-project/executor:v1.9.0-debug

.gitops_template: &gitops_base
  image: alpine/git:latest
  before_script:
    - apk add --no-cache yq openssh-client
    - eval $(ssh-agent -s)
    - echo "$GITOPS_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

stages:
  - .pre
  - validate
  - test
  - security
  - build
  - integration-test
  - deploy-staging
  - e2e-test
  - deploy-production
  - .post

# =============================================================================
# PRE-STAGE: Environment Setup and Cache Warming
# =============================================================================

cache-backend-dependencies:
  stage: .pre
  <<: *java_base
  <<: *maven_cache
  script:
    - cd backend
    - mvn $MAVEN_CLI_OPTS dependency:go-offline
    - mvn $MAVEN_CLI_OPTS dependency:resolve-sources
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

cache-frontend-dependencies:
  stage: .pre
  <<: *node_base
  <<: *node_cache
  script:
    - npm ci --cache .npm --prefer-offline
  rules:
    - <<: *frontend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

# =============================================================================
# VALIDATION STAGE: Code Quality and Structure Validation (All Events)
# =============================================================================

validate-backend:
  stage: validate
  <<: *java_base
  <<: *maven_cache
  script:
    - echo "🔍 Validating backend project structure and dependencies..."
    - cd backend
    - mvn $MAVEN_CLI_OPTS validate
    - mvn $MAVEN_CLI_OPTS dependency:analyze
  artifacts:
    expire_in: 1 hour
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

validate-frontend:
  stage: validate
  <<: *node_base
  <<: *node_cache
  script:
    - echo "🔍 Validating frontend project structure..."
    - npm ci --cache .npm --prefer-offline
    - npx ng version
    - npm audit --audit-level=high
  rules:
    - <<: *frontend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

compile-backend:
  stage: validate
  <<: *java_base
  <<: *maven_cache
  script:
    - echo "🏗️ Compiling backend application..."
    - cd backend
    - mvn $MAVEN_CLI_OPTS clean compile
    - mvn $MAVEN_CLI_OPTS compiler:testCompile
  artifacts:
    paths:
      - backend/target/classes/
      - backend/target/test-classes/
    expire_in: 2 hours
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

# =============================================================================
# TEST STAGE: Unit Tests (All Events)
# =============================================================================

backend-unit-tests:
  stage: test
  <<: *java_base
  <<: *maven_cache
  script:
    - echo "🧪 Running backend unit tests..."
    - cd backend
    - mvn $MAVEN_CLI_OPTS test -Dspring.profiles.active=test
    - echo "📊 Generating test coverage report..."
    - mvn jacoco:report
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: jacoco
        path: backend/target/site/jacoco/jacoco.xml
    paths:
      - backend/target/surefire-reports/
      - backend/target/site/jacoco/
    expire_in: 1 week
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
  dependencies:
    - compile-backend

frontend-unit-tests:
  stage: test
  <<: *node_base
  <<: *node_cache
  script:
    - echo "🧪 Running frontend unit tests..."
    
  artifacts:
    when: always
    expire_in: 1 week
  rules:
    - <<: *frontend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

# =============================================================================
# SECURITY & QUALITY STAGE: SonarQube Analysis (Merge Request + Main Branch Only)
# =============================================================================

sonarqube-backend:
  stage: security
  <<: *java_base
  <<: *maven_cache
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - echo "🔍 Running SonarQube analysis for backend..."
    - apt-get update -qq && apt-get install -y -qq wget unzip
    - wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
    - unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
    - export PATH="$PWD/sonar-scanner-5.0.1.3006-linux/bin:$PATH"
    - cd backend
    - sonar-scanner
      -Dsonar.host.url=${SONAR_HOST_URL}
      -Dsonar.login=${SONAR_TOKEN}
      -Dsonar.projectKey=${CI_PROJECT_NAME}-backend
      -Dsonar.projectName="${CI_PROJECT_NAME}-backend"
      -Dsonar.projectVersion=${CI_COMMIT_SHORT_SHA}
      -Dsonar.sources=src/main/java
      -Dsonar.tests=src/test/java
      -Dsonar.java.binaries=target/classes
      -Dsonar.java.test.binaries=target/test-classes
      -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
      -Dsonar.junit.reportPaths=target/surefire-reports
      -Dsonar.qualitygate.wait=true
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - backend-unit-tests
    - compile-backend
  allow_failure: false

dependency-security-scan:
  stage: security
  <<: *java_base
  <<: *maven_cache
  script:
    - echo "🛡️ Running dependency security scan..."
    - cd backend
    - mvn $MAVEN_CLI_OPTS org.owasp:dependency-check-maven:check
  artifacts:
    when: always
    paths:
      - backend/target/dependency-check-report.html
    expire_in: 1 week
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# =============================================================================
# BUILD STAGE: Application Packaging and Container Images (Merge Request + Main Branch)
# =============================================================================

build-backend:
  stage: build
  <<: *java_base
  <<: *maven_cache
  script:
    - echo "📦 Building backend application..."
    - cd backend
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
    - echo "✅ Backend packaged successfully"
    - ls -la target/
  artifacts:
    paths:
      - backend/target/*.jar
    expire_in: 1 day
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - compile-backend

build-frontend:
  stage: build
  <<: *node_base
  <<: *node_cache
  script:
    - echo "📦 Building frontend application..."
    - npm run build
    - echo "✅ Frontend built successfully"
    - ls -la dist/
  artifacts:
    paths:
      - frontend/bank-account-app/dist/
    expire_in: 1 day
  rules:
    - <<: *frontend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

docker-build-backend:
  stage: build
  <<: *kaniko_base
  script:
    - echo "🐳 Building backend Docker image..."
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${BACKEND_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      --destination "${BACKEND_IMAGE}:latest"
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - build-backend

docker-build-frontend:
  stage: build
  <<: *kaniko_base
  script:
    - echo "🐳 Building frontend Docker image..."
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile.frontend"
      --destination "${FRONTEND_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      --destination "${FRONTEND_IMAGE}:latest"
  rules:
    - <<: *frontend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *frontend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - build-frontend

# =============================================================================
# INTEGRATION TEST STAGE: Simplified Backend Database Integration (Merge Request + Main Branch)
# =============================================================================

backend-integration-tests:
  stage: integration-test
  <<: *java_base
  <<: *maven_cache
  script:
    - echo "🔗 Running simplified backend integration tests with H2 database..."
    - cd backend
    - echo "Starting H2 in-memory database for integration tests"
    - mvn $MAVEN_CLI_OPTS verify -Dspring.profiles.active=integration-test
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/failsafe-reports/TEST-*.xml
        - backend/target/surefire-reports/TEST-*.xml
    paths:
      - backend/target/failsafe-reports/
      - backend/target/surefire-reports/
    expire_in: 1 week
  rules:
    - <<: *backend_changes
      if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - <<: *backend_changes
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - build-backend

# =============================================================================
# DEPLOY STAGING STAGE: Automatic Deployment to Staging (Main Branch Only)
# =============================================================================

deploy-staging:
  stage: deploy-staging
  <<: *gitops_base
  script:
    - echo "🚀 Deploying to staging environment via GitOps..."
    - git clone $GITOPS_STAGING_REPO gitops-staging
    - cd gitops-staging
    - |
      # Update backend image tag
      if [ -n "$BACKEND_IMAGE" ]; then
        yq eval ".spec.template.spec.containers[0].image = \"${BACKEND_IMAGE}:${CI_COMMIT_SHORT_SHA}\"" -i applications/backend/deployment.yaml
        echo "Updated backend image to: ${BACKEND_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      fi
    - |
      # Update frontend image tag  
      if [ -n "$FRONTEND_IMAGE" ]; then
        yq eval ".spec.template.spec.containers[0].image = \"${FRONTEND_IMAGE}:${CI_COMMIT_SHORT_SHA}\"" -i applications/frontend/deployment.yaml
        echo "Updated frontend image to: ${FRONTEND_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      fi
    - |
      # Commit and push changes
      git config user.name "GitLab CI"
      git config user.email "ci@gitlab.com"
      git add .
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "Deploy ${CI_PROJECT_NAME} ${CI_COMMIT_SHORT_SHA} to staging
        
        Source commit: ${CI_COMMIT_SHA}
        Pipeline: ${CI_PIPELINE_URL}
        Branch: ${CI_COMMIT_REF_NAME}"
        git push origin main
        echo "✅ Staging deployment triggered via GitOps"
      fi
  environment:
    name: staging
    url: $STAGING_BASE_URL
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - docker-build-backend
    - docker-build-frontend

# =============================================================================
# E2E TEST STAGE: End-to-End Testing Against Staging (Main Branch Only, After Deployment)
# =============================================================================

e2e-tests:
  stage: e2e-test
  image: cypress/included:13.6.2
  variables:
    CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/.cypress"
    CYPRESS_baseUrl: "$STAGING_BASE_URL"
  cache:
    key: "$CI_COMMIT_REF_SLUG-cypress"
    paths:
      - .cypress/
      - frontend/bank-account-app/node_modules/
  before_script:
    - echo "🎭 Setting up E2E testing environment..."
    - echo "Waiting for staging deployment to be ready..."
    - sleep 120
    - apk add --no-cache curl
    - cd frontend/bank-account-app
    - npm ci
    - echo "Testing connectivity to staging environment at $STAGING_BASE_URL"
  script:
    - echo "🧪 Running E2E tests against staging environment..."
    - |
      # Wait for staging environment to be responsive
      for i in $(seq 1 30); do
        if curl -f "$STAGING_BASE_URL/health" >/dev/null 2>&1; then
          echo "✅ Staging environment is ready"
          break
        fi
        echo "⏳ Waiting for staging environment... attempt $i/30"
        sleep 10
      done
    - npm run e2e:headless
  artifacts:
    when: always
    paths:
      - frontend/bank-account-app/cypress/screenshots/
      - frontend/bank-account-app/cypress/videos/
    reports:
      junit:
        - frontend/bank-account-app/cypress/results/junit.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - deploy-staging

# =============================================================================
# DEPLOY PRODUCTION STAGE: Manual Deployment to Production (Main Branch Only)
# =============================================================================

deploy-production:
  stage: deploy-production
  <<: *gitops_base
  script:
    - echo "🚀 Deploying to production environment via GitOps..."
    - git clone $GITOPS_PROD_REPO gitops-production
    - cd gitops-production
    - |
      # Update backend image tag
      if [ -n "$BACKEND_IMAGE" ]; then
        yq eval ".spec.template.spec.containers[0].image = \"${BACKEND_IMAGE}:${CI_COMMIT_SHORT_SHA}\"" -i applications/backend/deployment.yaml
        echo "Updated backend image to: ${BACKEND_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      fi
    - |
      # Update frontend image tag
      if [ -n "$FRONTEND_IMAGE" ]; then
        yq eval ".spec.template.spec.containers[0].image = \"${FRONTEND_IMAGE}:${CI_COMMIT_SHORT_SHA}\"" -i applications/frontend/deployment.yaml
        echo "Updated frontend image to: ${FRONTEND_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      fi
    - |
      # Commit and push changes
      git config user.name "GitLab CI"
      git config user.email "ci@gitlab.com"
      git add .
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "Deploy ${CI_PROJECT_NAME} ${CI_COMMIT_SHORT_SHA} to production
        
        Source commit: ${CI_COMMIT_SHA}
        Pipeline: ${CI_PIPELINE_URL}
        Branch: ${CI_COMMIT_REF_NAME}
        Approved by: ${GITLAB_USER_NAME}"
        git push origin main
        echo "✅ Production deployment triggered via GitOps"
      fi
  environment:
    name: production
    url: $PRODUCTION_BASE_URL
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: false
  dependencies:
    - e2e-tests

# =============================================================================
# POST-STAGE: Cleanup and Notifications
# =============================================================================

cleanup-workspace:
  stage: .post
  image: alpine:latest
  script:
    - echo "🧹 Cleaning up workspace..."
    - rm -rf backend/target/
    - rm -rf frontend/bank-account-app/dist/
    - rm -rf frontend/bank-account-app/node_modules/
  when: always
  allow_failure: true
